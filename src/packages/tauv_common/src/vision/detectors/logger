#!/usr/bin/env python3

import rospy
from tauv_msgs.msg import RegisterObjectDetections, BucketDetection, BucketList
from tauv_msgs.srv import MapFind, MapFindClosest
from visualization_msgs.msg import MarkerArray, Marker
from geometry_msgs.msg import Point
import numpy as np

def getColor(tag, trans=False):
    color = [1,0,0,1]
    if(tag=="badge"):
        color = [0,1,0,1]

    if(tag=="notebook"):
        color = [0,0,1,1]

    if(not trans):
        color[3] = 0.75

    return color

def makeMarker(id, detection, color, scale = 0.5, shape = Marker.SPHERE, time = rospy.Duration(1.0)):
    marker = Marker()
    marker.header.frame_id = "base_link"
    marker.header.stamp = rospy.Time()
    marker.ns = "my_namespace"
    marker.id = id
    marker.type = shape
    marker.action = Marker.ADD
    marker.pose.position.x = detection.position.x
    marker.pose.position.y = detection.position.y
    marker.pose.position.z = detection.position.z
    marker.pose.orientation.x = 0.0
    marker.pose.orientation.y = 0.0
    marker.pose.orientation.z = 0.0
    marker.pose.orientation.w = 1.0
    marker.scale.x = scale
    marker.scale.y = scale
    marker.scale.z = scale
    marker.color.a = color[3]
    marker.color.r = color[0]
    marker.color.g = color[1]
    marker.color.b = color[2]
    marker.lifetime = time
    
    return marker


class Logger():
    def __init__(self):
        rospy.init_node('logger')
        rospy.Subscriber("/register_object_detection", RegisterObjectDetections,
                                                self.callback)

        rospy.Subscriber("/global_map/find", BucketList,
                                        self.visualize)

        rospy.wait_for_service("/global_map/find")
        self.find = rospy.ServiceProxy("/global_map/find", MapFind)

        self.pub = rospy.Publisher("/register_object_detection", RegisterObjectDetections,
                                                queue_size=10)
        self.viz = rospy.Publisher("/visualization_marker_array", MarkerArray, queue_size=100)
        
        
        self.arr = [self.getObj1, self.getObj2, self.getObj3, self.getObj4, self.getObj5]
        self.arrInd = [0,1,2,3,4]

        self.ind = 10000
        self.var1 = 1
        self.var2 = 1

        rospy.Timer(rospy.Duration(1.0/4.0), self.publish)
        rospy.Timer(rospy.Duration(5.0), self.visualize)
        rospy.Timer(rospy.Duration(30), self.publish6)
        rospy.Timer(rospy.Duration(30.5), self.publish6)

    def callback(self, data):
        print("CALLBACK")
        print(data)

    def visualize(self, time):
        #buckets = bucketList.bucket_list
        buckets1 = self.find("badge").detections
        buckets2 = self.find("phone").detections
        buckets3 = self.find("notebook").detections

        markers = []
        for ind in range(len(buckets1)):
            det = buckets1[ind]
            markers.append(makeMarker(ind, det, getColor(det.tag), 1, Marker.CUBE, rospy.Duration(5.0)))

        for ind in range(len(buckets2)):
            det = buckets2[ind]
            markers.append(makeMarker(ind, det, getColor(det.tag), 1, Marker.CUBE, rospy.Duration(5.0)))

        for ind in range(len(buckets3)):
            det = buckets3[ind]
            markers.append(makeMarker(ind, det, getColor(det.tag), 1, Marker.CUBE, rospy.Duration(5.0)))

        OBJ = MarkerArray()
        OBJ.markers = markers
        self.viz.publish(OBJ)

    def publish(self, time):
        objInd = np.random.choice(self.arrInd, np.random.randint(1, high=5), replace=False)

        detections = []
        markers = []
        for ind in objInd:
            detection = self.arr[ind]()
            detections.append(detection)

            markers.append(makeMarker(self.ind, detection, getColor(detection.tag, True)))
            self.ind+=1

        objDets = RegisterObjectDetections()
        objDets.objdets = detections
        self.pub.publish(objDets)

        markersPub = MarkerArray()
        markersPub.markers = markers
        self.viz.publish(markersPub)

    def publish6(self, time):
        objDets = RegisterObjectDetections()
        det = self.getObj6()
        objDets.objdets = [det]
        self.pub.publish(objDets)

        markersPub = MarkerArray()
        markersPub.markers = [makeMarker(self.ind, det, getColor(det.tag, True), scale=2, shape=Marker.CYLINDER)]
        self.ind+=1
        self.viz.publish(markersPub)

    def getObj1(self):
        det1 = BucketDetection()
        det1.position = Point(np.random.normal(loc=1.0, scale=self.var2),np.random.normal(loc=1.0, scale=self.var2),np.random.normal(loc=1.0, scale=self.var2))
        det1.tag = "badge"

        return det1

    def getObj2(self):
        det2 = BucketDetection()
        det2.position = Point(np.random.normal(loc=15.5, scale=self.var1),np.random.normal(loc=15.5, scale=self.var2),np.random.normal(loc=15.5, scale=self.var1))
        det2.tag = "badge"

        return det2

    def getObj3(self):
        det1 = BucketDetection()
        det1.position = Point(np.random.normal(loc=1.5, scale=self.var1),np.random.normal(loc=1.5, scale=self.var1),np.random.normal(loc=1.5, scale=self.var1))
        det1.tag = "notebook"

        return det1
        
    def getObj4(self):
        det1 = BucketDetection()
        det1.position = Point(np.random.normal(loc=20.5, scale=self.var1),np.random.normal(loc=20.5, scale=self.var1),np.random.normal(loc=5, scale=self.var2))
        det1.tag = "notebook"

        return det1

    def getObj5(self):
        det1 = BucketDetection()
        det1.position = Point(np.random.normal(loc=10.5, scale=self.var1),np.random.normal(loc=10.5, scale=self.var1),np.random.normal(loc=5, scale=self.var2))
        det1.tag = "phone"

        return det1

    def getObj6(self):
        det1 = BucketDetection()
        det1.position = Point(np.random.normal(loc=30, scale=self.var1),np.random.normal(loc=30, scale=self.var1),np.random.normal(loc=5, scale=self.var1))
        det1.tag = "badge"

        return det1

s = Logger()
rospy.spin()